{% extends "base.html" %}
{% load static %}

{% block title %}{% if is_edit %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ{% else %}–°–æ–∑–¥–∞–Ω–∏–µ{% endif %} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <div class="card">
            <div class="card-header">
                <h2 class="h4 mb-0">
                    {% if is_edit %}
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                    {% else %}
                        –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                    {% endif %}
                </h2>
            </div>
            <div class="card-body">
                <form method="post" id="transaction-form">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.created_date.id_for_label }}" class="form-label">
                                {{ form.created_date.label }}
                            </label>
                            {{ form.created_date }}
                            {% if form.created_date.errors %}
                                <div class="text-danger">{{ form.created_date.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.status.id_for_label }}" class="form-label">
                                {{ form.status.label }} <span class="text-muted">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                            </label>
                            {{ form.status }}
                            {% if form.status.errors %}
                                <div class="text-danger">{{ form.status.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.transaction_type.id_for_label }}" class="form-label">
                                {{ form.transaction_type.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.transaction_type }}
                            {% if form.transaction_type.errors %}
                                <div class="text-danger">{{ form.transaction_type.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.amount.id_for_label }}" class="form-label">
                                {{ form.amount.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.amount }}
                            {% if form.amount.errors %}
                                <div class="text-danger">{{ form.amount.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.category.id_for_label }}" class="form-label">
                                {{ form.category.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.category }}
                            {% if form.category.errors %}
                                <div class="text-danger">{{ form.category.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.subcategory.id_for_label }}" class="form-label">
                                {{ form.subcategory.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.subcategory }}
                            {% if form.subcategory.errors %}
                                <div class="text-danger">{{ form.subcategory.errors }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.comment.id_for_label }}" class="form-label">
                            {{ form.comment.label }} <span class="text-muted">(–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</span>
                        </label>
                        {{ form.comment }}
                        {% if form.comment.errors %}
                            <div class="text-danger">{{ form.comment.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <small class="text-muted">
                            <span class="text-danger">*</span> –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è
                        </small>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'app:transaction_list' %}" class="btn btn-secondary me-md-2">–û—Ç–º–µ–Ω–∞</a>
                        
                        {% if is_edit %}
                            <button type="button" class="btn btn-danger me-md-2" data-bs-toggle="modal" data-bs-target="#deleteModal">
                                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                            </button>
                        {% endif %}
                        
                        <button type="submit" class="btn btn-primary">
                            {% if is_edit %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- –£–¥–∞–ª–µ–Ω–∏–µ -->

{% if is_edit %}
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é?</p>
                <div class="alert alert-warning">
                    <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.
                </div>
                <div class="transaction-info">
                    <strong>–î–µ—Ç–∞–ª–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:</strong><br>
                    –î–∞—Ç–∞: {{ transaction.created_date|date:"d.m.Y" }}<br>
                    –¢–∏–ø: {{ transaction.get_transaction_type_display }}<br>
                    –°—É–º–º–∞: {{ transaction.amount }} —Ä—É–±.<br>
                    –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {{ transaction.category.name }}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <form method="post" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" name="delete" class="btn btn-danger">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    $(document).ready(function() {
        $('#category-select').change(function() {
            var categoryId = $(this).val();
            if (categoryId) {
                $.ajax({
                    url: "{% url 'app:ajax_load_subcategories' %}",
                    data: {
                        'category_id': categoryId
                    },
                    success: function(data) {
                        $('#subcategory-select').empty();
                        $('#subcategory-select').append('<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>');
                        $.each(data, function(index, item) {
                            $('#subcategory-select').append('<option value="' + item.id + '">' + item.name + '</option>');
                        });
                        
                        {% if is_edit and transaction %}
                            $('#subcategory-select').val({{ transaction.subcategory.id }});
                        {% endif %}
                    }
                });
            } else {
                $('#subcategory-select').empty();
                $('#subcategory-select').append('<option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>');
            }
        });

        {% if is_edit and transaction %}
            $(document).ready(function() {
                var categoryId = $('#category-select').val();
                if (categoryId) {
                    $.ajax({
                        url: "{% url 'app:ajax_load_subcategories' %}",
                        data: {
                            'category_id': categoryId
                        },
                        success: function(data) {
                            $('#subcategory-select').empty();
                            $('#subcategory-select').append('<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏—é...</option>');
                            $.each(data, function(index, item) {
                                $('#subcategory-select').append('<option value="' + item.id + '">' + item.name + '</option>');
                            });
                            $('#subcategory-select').val({{ transaction.subcategory.id }});
                        }
                    });
                }
            });
        {% endif %}
    });
    document.addEventListener('DOMContentLoaded', function() {
        const statusSelect = document.getElementById('id_status');
        const statuses = [
            {id: '', name: '---------'},
            {% for status in statuses %}
            {id: '{{ status.name }}', name: '{{ status.name }}'},
            {% endfor %}
        ];
        
        statuses.forEach(status => {
            const option = document.createElement('option');
            option.value = status.id;
            option.textContent = status.name;
            statusSelect.appendChild(option);
        });
        
        const typeSelect = document.getElementById('id_transaction_type');
        const types = [
            {id: '', name: '---------'},
            {% for type in types %}
            {id: '{{ type.name }}', name: '{{ type.name }}'},
            {% endfor %}
        ];
        
        types.forEach(type => {
            const option = document.createElement('option');
            option.value = type.id;
            option.textContent = type.name;
            typeSelect.appendChild(option);
        });
        {% if is_edit and transaction %}
            if (statusSelect) statusSelect.value = '{{ transaction.status }}';
            if (typeSelect) typeSelect.value = '{{ transaction.transaction_type }}';
        {% endif %}
    });
</script>
{% endblock %}